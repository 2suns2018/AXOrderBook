# 订单簿重建流程

## 标的交易状态判断

交易状态切换(主要是集合竞价的结束)将导致撮合的产生，从而需要生成新的订单簿。
尽早地判断到交易状态切换的切换有利于尽早地输出新订单簿。

### 交易状态分类

* 市场状态

内部编码|状态|对应深交所编码|对应上交所编码|物理世界时间
--|--|--|--|--
0|启动（开市前）|'S'=启动（开市前）|'S'=启动（开市前）时段|<9:15:00
1|开盘集合竞价|'O'=开盘集合竞价|'C'=开盘集合竞价时段|[9:15:00, 9:25:00)
2|开盘集合竞价后休市|'B'=休市|'B'=休市时段|[9:25:00, 9:30:00)
3|连续竞价（上午）|'T'=连续竞价|'T'=连续交易时段|[9:30:00, 11:30:00)
4|中午休市|'B'=休市|'B'=休市时段|[11:30:00, 13:00:00)
5|连续竞价（下午）|'T'=连续竞价|'T'=连续交易时段|[13:00:00, 14:57:00)
6|收盘集合竞价|'C'=收盘集合竞价|'U'=收盘集合竞价时段|[14:57:00, 15:00:00)
7|收盘集合竞价后休市|'B'=休市||[15:00:00, 15:05:00)
8|盘后交易|'A'=盘后交易||创业板[15:05:00, 15:30:00)
9|已闭市|'E'=已闭市|'E'=闭市时段|创业板>=15:30:00; 其它>=15:00:00
10|波动性中断|'V'=波动性中断|'V'=波动性中断
11|停牌|'H'=临时停牌|'P'=产品停牌
12|熔断时段||'M' or 'N'

TODO: 确认 15:00:00~15:05:00

* 标的状态

内部编码|状态|对应深交所编码|对应上交所编码
--|--|--|--
0|可交易|'0'=正常状态|'1'=可正常交易/已上市/可接受订单申报;
1|不可交易|'1'=全天停牌|'0'=不可正常交易/未上市/不接受订单申报;

*期权限制开仓与否不影响OB重建，因此不需要反映到状态中。*

### 判断流程

* 仅快照内有交易阶段代码
* 在交易阶段切换时标的快照不一定及时到来
* 基于逐笔消息内时间戳可以弥补快照缺失时的判断
* 整个 宏单元 或 所有 宏单元 共享一个交易所交易阶段标志
* 大多数情况下市场状态将早于标的状态更新
  * 即：当FPGA收到第一个切换交易阶段的消息时（可能是快照，也可能是逐笔），意味着物理世界的时间已经切换，因此整个FPGA的交易阶段也应跟着切换
