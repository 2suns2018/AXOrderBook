# 设计说明书

## 目标

在Xilinux Alveo U50上实现单板512只~4096只个股的订单簿重建。

## 设计约束

>### Xilinux Alveo U50资源

单元|数量
--|--
LUT|872K
REG|1473K
36Kb BRAM|1344
288Kb URAM|640
HBM2|4GB x2, 256B位宽

>### 宏单元

* 宏单元作为本设计的主要设计对象，每个宏单元管理若干只个股：
  * 若每个宏单元管理```64```只个股：
    * 单板处理```512```只个股则需要```8```个宏单元
    * 单板处理```4096```只个股则需要```64```个宏单元
* 宏单元之间并行处理，宏单元内部串行处理
* 宏单元前接```路由单元```：根据securityID将L2消息分发给对应的宏单元，宏单元busy时缓存消息
* 宏单元后接```仲裁单元```：将不同宏单元输出的快照汇聚成一路数据流，缓存宏单元输出，不反压宏单元
* 所有宏单元共用一组```存储管理单元```访问片外存储器
* 每个宏单元内部：
  * 管理的个股名单可配置，每日开盘前统计前一日L2消息数，估计宏单元的处理总量，实现负载均衡
    * 需要有动态分配能力：为了保证订单号唯一，宏单元内部的个股必须是同一个channel，但某只个股的channel号不是固定的，需要在首个L2消息到达时识别并分配给某个宏单元
    * 盘前给每个个股分配L2消息权重、估算平均权重，FPGA动态分配个股：保证宏单元内channel相同、宏单元间权重和接近
  * 串行处理管理的个股的L2消息，不做消息缓存，busy反压给前级路由单元
  * 统一存储空间和管理（片内+片外）
    * 订单列表
      * 管理的所有个股的两个订单列表(bid/ask)存放在同一块片外空间
    * 价格档位
      * 每个个股独立、均有两棵价格树(bid/ask)
      * 所有个股共享树管理模块，所有树节点在同一个片内空间
      * 所有树节点指向的数据放在同一块片外空间
    * 价格档位对应的订单队列
      * 以链表组织，存储在片外
    * 整理空间
      * 9:25~9:30/11:30~13:00
      * 动态
  * 统一现场保存/恢复机制
* 输出不接受反压，后级仲裁单元总是能接收宏单元输出
* 宏单元个股数、空间将在测试后综合决定，设计期间将有大量的预定义宏

>### 资源估计

* 价格位宽
  * 深交所个股均价17.88，最高503.00
  * 20bit=10485.75, 19bit=5242.87
  * 取20b
* 数量位宽
  * 单笔最大委托1万手    = 1,000,000 股
  * 深交所精度*100(2位小数)， 最大 = 100,000,000
  * 上交所精度*1000(3位小数)，最大 = 1,000,000,000
  * 取30b = 1,073,741,823
* 成交额位宽
  * 只个股千亿成交额 = 100,000,000,000 元
  * 深交所精度*10000(4位小数)
  * 上交所精度*100000(5位小数) = 10,000,000,000,000,000
  * 取54b = 18,014,398,509,481,983
* 宏单元个股委托
  * 个股委托数量（合并bid/ask）均值28,888，最高366,621
  * 以数组形式存放，宏单元内部共享一块片外空间
    * 宏单元内个股按平均32,576条委托估计
    * 宏单元内个股数按64估计
    * 32576 * 64 = 2,084,864 = 2M条委托
    * HBM位宽256bit = 32B 足够存放单条委托信息
    * 即单个宏单元委托需要外部空间 64MB
    * 若单板64个宏单元，则需要 64MB * 64 = 4,096MB = 4GB HBM空间
* 价格档位TODO

>### A股市场状态

* 深市
  * 价格分布
  * 委托数目
    * 限价单
    * 市价单
    * 本方最优
  * 成交数目
  * 撤单数目

### python

### FPGA HLS

## 结构

### 统一指令

### 主动式

#### 存储和资源

### 被动式

#### 存储和资源

## 测试

## 实机
