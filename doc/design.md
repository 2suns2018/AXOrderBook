# 设计说明书

## 目标

在Xilinux Alveo U50上实现单板512只~4096只个股的订单簿重建。

上交所和深交所消息格式差异主要在

## 设计约束

>### Xilinux Alveo U50资源

单元|数量|说明
--|--|--
LUT|872K
REG|1473K
36Kb BRAM|1344|32K x 1, 16K x 2, 8K x 4, 4K x 9, 2K x 18, 1K x 36, or 512 x 72, 16K x 1, 8K x 2, 4K x 4, 2K x 9, 1K x 18 or 512 x 36
288Kb URAM|640|4K x 72
HBM2|4GB x2, 256B位宽

>### 宏单元

* 宏单元作为本设计的主要设计对象，每个宏单元管理若干只个股：
  * 若每个宏单元管理```64```只个股：
    * 单板处理```512```只个股则需要```8```个宏单元
    * 单板处理```4096```只个股则需要```64```个宏单元
* 宏单元之间并行处理，宏单元内部串行处理
* 宏单元前接```路由单元```：根据securityID将L2消息分发给对应的宏单元，宏单元busy时缓存消息
* 宏单元后接```仲裁单元```：将不同宏单元输出的快照汇聚成一路数据流，缓存宏单元输出，~~~不反压宏单元~~~
* 所有宏单元共用一组```存储管理单元```访问片外存储器
* 每个宏单元内部：
  * 管理的个股名单可配置，每日开盘前统计前一日L2消息数，估计宏单元的处理总量，实现负载均衡
    * 需要有动态分配能力：为了保证订单号唯一，宏单元内部的个股必须是同一个channel，但某只个股的channel号不是固定的，需要在首个L2消息到达时识别并分配给某个宏单元
    * 盘前给每个个股分配L2消息权重、估算平均权重，FPGA动态分配个股：保证宏单元内channel相同、宏单元间权重和接近
    * 宏单元内部自行对securityID编码，减小空间占用，输出重建订单簿时还原
  * 串行处理管理的个股的L2消息，不做消息缓存，busy反压给前级路由单元
    * ap_ctrl_chain 模式
  * 统一存储空间和管理（片内+片外）
    * 订单列表
      * 管理的所有个股的所有订单列表(bid/ask混合)存放在同一块片外空间
    * 价格档位
      * 每个个股独立、均有两棵价格树(bid/ask各一棵)
      * 所有个股共享树管理模块，所有树节点在同一个片内空间
      * 所有树节点指向的数据放在同一块片外空间
    * 价格档位对应的订单队列
      * 以链表组织，存储在片外
    * 整理空间
      * 9:25~9:30/11:30~13:00
      * 必要时动态整理
        * 订单列表的最新区域空泡超过阈值
        * 某片区域可以通过整理返还
        * 链表或数组空泡超过阈值，加速查找
  * 统一现场保存/恢复机制
    * 用于测试时快速重现、软件分析片内状态
    * 生产中软件恢复现场
* ~~~输出不接受反压，后级仲裁单元总是能接收宏单元输出~~~ ap_ctrl_chain 模式
* 宏单元个股数、空间将在测试后综合决定，设计期间将有大量的预定义宏

>### 资源估计

* 价格位宽
  * 深交所个股均价17.88，最高503.00
  * 20bit=10485.75, 19bit=5242.87
  * 取20b
  * 深交所消息价格精度为N13(4)，完全兼容需44bit
* 数量位宽
  * 单笔最大委托1万手    = 1,000,000 股
  * 深交所精度*100(2位小数)， 最大 = 100,000,000
  * 上交所精度*1000(3位小数)，最大 = 1,000,000,000
  * 取30b = 1,073,741,823
  * 单个价格档位以100万手估计 37b = 137,438,953,471
  * 深交所消息数量精度为N15(2)，完全兼容需50bit
* 成交额位宽
  * 只个股千亿成交额 = 100,000,000,000 元
  * 深交所精度*10000(4位小数)
  * 上交所精度*100000(5位小数) = 10,000,000,000,000,000
  * 取54b = 18,014,398,509,481,983
  * 深交所消息数量精度为N18(4)，完全兼容需60bit
* 宏单元个股委托
  * 单条委托信息位宽
    * 订单信息 16B
      * 委托序列号 64b
      * securityID，索引形式，0~63 = 6b
      * 价格 20b
      * 数量 30b
      * 委托方向（卖/卖/借入/借出） 2b
      * 委托类型（深圳：市价/限价/本方最优；上海：新增/删除） 2b (仅深圳)
      * 余 4b
    * 数据结构 5B
      * 所在订单链表的地址（估算在下） 21b
      * 所属价格挡位的地址(13,000个档位) 14b
      * 余 4b
  * 个股委托数量（合并bid/ask）均值28,888，最高366,621
  * 以数组形式存放，宏单元内部共享一块片外空间
    * 宏单元内个股按平均32,576条委托估计（略紧张）
    * 宏单元内个股数按64估计
    * 32576 * 64 = 2,084,864 = 2M条委托， 地址 21b
    * HBM位宽256bit = 32B，单个地址可存放 1 条委托
    * 即单个宏单元委托需要外部空间 64MB
  * 若单板64个宏单元，则需要 64MB * 64 = 4,096MB = 4GB HBM空间
  * 或单板32个宏单元，单个宏单元128MB， = 4GB HBM空间
* 宏单元价格档位
  * 深交所价格中位数10.18，均值17.88
  * 按20%涨跌停估计，最大400档~700档
  * 假设30%档位有挂单，120~210档，单个宏单元64个股总计 13,000 档 = 14b
  * 单个档位信息位宽
    * 档位信息  10B
      * 价格 20b
      * 单个档位总量(100手) 37b
      * 单个档位总委托笔数(6万笔) 16b
      * 余 7b
    * 数据结构  12B
      * 根节点地址 14b
      * 父节点地址 14b
      * 左节点地址 14b
      * 右节点地址 14b
      * 左树深度 8b
      * 右树深度 8b
      * 价格链表入口 21b
  * 位宽 22B 需要 (URAM 72b x3, 余40b) 或 (BRAM 36b x5，余4b)
  * 深度需要 (URAM 4096 x4)  或 (BRAM 1K x14)
  * 单个宏单元需要 12 块URAM 或 70 块BRAM
  * 若单板64个宏单元，则需要 768 块URAM 或 4480 块BRAM
  * **资源不足！考虑减小总档位(深度)或减少宏单元总数**
* 宏单元价格档委托队列
  * 每个价格档位对应一条委托队列，记录本档位未成交的委托
  * 总条目数与 宏单元个股委托 相等
  * 单个节点信息位宽
    * 订单信息 8B
      * 委托序列号 64b
    * 数据结构 6B
      * 下一节点地址 21b
      * 上一节点地址 21b
    * HBM位宽256bit = 32B，单个地址可存放 2 个节点
    * 单个宏单元委托需要外部空间 32MB
  * 若单板64个宏单元，则需要 2GB HBM空间

预计U50单板塞64个宏单元较为拥挤，32个应可行。

>### A股市场状态

见[L2行情消息细节](/doc/msgTypes.md)

* 深市
  * 价格分布
  * 委托数目
    * 限价单
    * 市价单
    * 本方最优
  * 成交数目
  * 撤单数目

### python

### FPGA HLS

## 结构

### 统一指令

### 主动式

#### 存储和资源

### 被动式

#### 存储和资源

## 测试

## 实机
